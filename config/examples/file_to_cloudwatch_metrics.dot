# Parsing logs as metrics and sending to CloudWatch
# ------------------------------------------------------------------------------
# WIP

digraph {
  data_dir = "/var/lib/vector"

  subgraph sources {
    # Ingest
    file [
      type = "file"
      include = "sample.log"
      start_at_beginning = true
    ]
  }

  subgraph transforms {
    # Structure and parse the data
    regex_parser [
      type = "regex_parser"
      regex = "^(?P<host>[\w\.]+) - (?P<user>[\w-]+) \[(?P<timestamp>.*)\] \"(?P<method>[\w]+) (?P<path>.*)\" (?P<status>[\d]+) (?P<bytes_out>[\d]+)$"
    ]

    # Transform into metrics
    log_to_metric [
      type = "log_to_metric"
    ]

    subgraph "log_to_metric.metrics" {
      type = "counter"
      increment_by_value = true
      field = "bytes_out"
      subgraph tags {
        method = "{{method}}"
        status = "{{status}}"
      }
    }
  }

  subgraph sinks {
    # Output data

    console_metrics [
      type = "console"
      encoding = "json"
    ]

    console_logs [
      type = "console"
      encoding = "json"
    ]

    cloudwatch [
      type = "aws_cloudwatch_metrics"
      namespace = "vector"
      endpoint = "http://localhost:4582"
    ]
  }

  # Set up data flow
  file -> regex_parser -> log_to_metric -> console_metrics
  regex_parser -> console_logs
  log_to_metric -> cloudwatch
}
