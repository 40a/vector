# Prometheus sink example
# ------------------------------------------------------------------------------
# Parsing logs as metrics and exposing into Prometheus

digraph {

  data_dir = "/var/lib/vector"

  subgraph sources {
    # Ingest
    file [
      type = "file"
      include = "sample.log"
      start_at_beginning = true
    ]
  }

  subgraph transforms {
    # Structure and parse the data
    regex_parser [
      type = "regex_parser"
      regex = "^(?P<host>[\w\.]+) - (?P<user>[\w-]+) \[(?P<timestamp>.*)\] \"(?P<method>[\w]+) (?P<path>.*)\" (?P<status>[\d]+) (?P<bytes_out>[\d]+)$"
    ]

    # Transform into metrics
    log_to_metric [
      type = "log_to_metric"
    ]

    subgraph "log_to_metric.metrics" {
      subgraph {
        type = "counter"
        field = "message"
      }
      subgraph {
        type = "counter"
        increment_by_value = true
        field = "bytes_out"
        name = "bytes_out_total"
      }
      subgraph {
        type = "gauge"
        field = "bytes_out"
      }
      subgraph {
        type = "set"
        field = "user"
      }
      subgraph {
        type = "histogram"
        field = "bytes_out"
        name = "bytes_out_histogram"
      }
    }
  }

  subgraph sinks {
    # Output data

    console_metrics [
      type = "console"
      encoding = "json"
    ]

    console_logs [
      type = "console"
      encoding = "text"
    ]

    prometheus [
      type = "prometheus"
      namespace = "vector"
      buckets = "0.0,10.0,100.0,1000.0,10000.0,100001.0"
    ]
  }

  # Set up the data flow
  file -> regex_parser -> log_to_metric -> prometheus
  log_to_metric -> console_metrics
  regex_parser -> console_logs
}
